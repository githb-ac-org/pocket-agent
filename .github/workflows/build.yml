name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-mac:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Import certificates
        env:
          CERTIFICATE_P12: ${{ secrets.CERTIFICATE_P12 }}
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
        run: |
          echo "$CERTIFICATE_P12" | base64 --decode > certificate.p12
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security import certificate.p12 -k build.keychain -P "$CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain

      - name: Build and notarize
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: npm run build && npx electron-builder --mac --arm64 --x64 -p never

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mac-build
          path: |
            release/*.dmg
            release/*.zip
            release/latest-mac.yml

  build-win:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build and package
        env:
          WIN_CSC_LINK: ${{ secrets.WIN_CSC_LINK }}
          WIN_CSC_KEY_PASSWORD: ${{ secrets.WIN_CSC_KEY_PASSWORD }}
        run: npm run build && npx electron-builder --win --x64 --arm64 -p never

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: win-build
          path: |
            release/*-setup.exe
            release/*.zip
            release/latest.yml

  release:
    needs: [build-mac, build-win]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: mac-build
          path: release/

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: win-build
          path: release/

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/*.dmg
            release/*.zip
            release/*-setup.exe
            release/latest-mac.yml
            release/latest.yml
          body: |
            ## Pocket Agent ${{ github.ref_name }}

            A persistent personal AI assistant with memory and scheduling.

            ### Downloads

            | Platform | Architecture | File |
            |----------|--------------|------|
            | macOS | Apple Silicon (M1/M2/M3/M4) | `Pocket-Agent-*-arm64-mac.dmg` |
            | macOS | Intel | `Pocket-Agent-*-x64-mac.dmg` |
            | Windows | x64 | `Pocket-Agent-*-x64-setup.exe` |
            | Windows | ARM64 | `Pocket-Agent-*-arm64-setup.exe` |

            ### Installation

            **macOS:**
            1. Download the DMG for your Mac
            2. Open the DMG and drag Pocket Agent to Applications
            3. Launch and enter your Anthropic API key

            **Windows:**
            1. Download the setup .exe for your architecture
            2. Run the installer (you may need to click "More info" â†’ "Run anyway" if unsigned)
            3. Launch Pocket Agent and enter your Anthropic API key
