<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com;">
  <title>Welcome to Pocket Agent</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400;500;600;700&family=Sora:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0a0b;
      --bg-secondary: #141415;
      --bg-tertiary: #1c1c1e;
      --border: #2a2a2d;
      --text-primary: #fafafa;
      --text-secondary: #a1a1a6;
      --text-muted: #636366;
      --accent: #a855f7;
      --accent-secondary: #ec4899;
      --accent-hover: #c084fc;
      --error: #ef4444;
      --success: #22c55e;
      --orange: #f97316;
      --radius: 16px;
      --radius-sm: 10px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Sora', -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', system-ui, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
    }

    .onboarding {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 32px 36px 40px 36px;
      overflow-y: auto;
    }

    .logo {
      width: 72px;
      height: 54px;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      flex-shrink: 0;
      animation: logoIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
      position: relative;
    }

    .logo::before {
      content: '';
      position: absolute;
      width: 3px;
      height: 3px;
      top: 0;
      left: 0;
      transform: scale(3);
      transform-origin: top left;
      animation: pixelcat 0.6s steps(1) infinite;
      image-rendering: pixelated;
    }

    @keyframes logoIn {
      from { opacity: 0; transform: scale(0.8) translateY(10px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    @keyframes pixelcat {
      /* Frame 1: Cat walking - legs apart */
      0%, 25% {
        box-shadow:
          /* Ears */
          3px 0 0 var(--accent), 9px 0 0 var(--accent),
          /* Head */
          3px 3px 0 var(--accent), 6px 3px 0 var(--accent), 9px 3px 0 var(--accent),
          0 6px 0 var(--accent), 3px 6px 0 var(--accent), 6px 6px 0 var(--accent), 9px 6px 0 var(--accent), 12px 6px 0 var(--accent),
          /* Eyes */
          3px 6px 0 #fff, 9px 6px 0 #fff,
          /* Body */
          3px 9px 0 var(--accent), 6px 9px 0 var(--accent), 9px 9px 0 var(--accent), 12px 9px 0 var(--accent), 15px 9px 0 var(--accent),
          3px 12px 0 var(--accent), 6px 12px 0 var(--accent), 9px 12px 0 var(--accent), 12px 12px 0 var(--accent),
          /* Tail up */
          18px 6px 0 var(--accent), 21px 3px 0 var(--accent),
          /* Legs - apart */
          3px 15px 0 var(--accent), 12px 15px 0 var(--accent);
      }
      /* Frame 2: Cat walking - legs together */
      25.01%, 50% {
        box-shadow:
          /* Ears */
          3px 0 0 var(--accent), 9px 0 0 var(--accent),
          /* Head */
          3px 3px 0 var(--accent), 6px 3px 0 var(--accent), 9px 3px 0 var(--accent),
          0 6px 0 var(--accent), 3px 6px 0 var(--accent), 6px 6px 0 var(--accent), 9px 6px 0 var(--accent), 12px 6px 0 var(--accent),
          /* Eyes */
          3px 6px 0 #fff, 9px 6px 0 #fff,
          /* Body */
          3px 9px 0 var(--accent), 6px 9px 0 var(--accent), 9px 9px 0 var(--accent), 12px 9px 0 var(--accent), 15px 9px 0 var(--accent),
          3px 12px 0 var(--accent), 6px 12px 0 var(--accent), 9px 12px 0 var(--accent), 12px 12px 0 var(--accent),
          /* Tail middle */
          18px 9px 0 var(--accent), 21px 6px 0 var(--accent),
          /* Legs - together */
          6px 15px 0 var(--accent), 9px 15px 0 var(--accent);
      }
      /* Frame 3: Cat walking - legs crossed */
      50.01%, 75% {
        box-shadow:
          /* Ears */
          3px 0 0 var(--accent), 9px 0 0 var(--accent),
          /* Head */
          3px 3px 0 var(--accent), 6px 3px 0 var(--accent), 9px 3px 0 var(--accent),
          0 6px 0 var(--accent), 3px 6px 0 var(--accent), 6px 6px 0 var(--accent), 9px 6px 0 var(--accent), 12px 6px 0 var(--accent),
          /* Eyes */
          3px 6px 0 #fff, 9px 6px 0 #fff,
          /* Body */
          3px 9px 0 var(--accent), 6px 9px 0 var(--accent), 9px 9px 0 var(--accent), 12px 9px 0 var(--accent), 15px 9px 0 var(--accent),
          3px 12px 0 var(--accent), 6px 12px 0 var(--accent), 9px 12px 0 var(--accent), 12px 12px 0 var(--accent),
          /* Tail down */
          18px 12px 0 var(--accent), 21px 9px 0 var(--accent),
          /* Legs - reversed */
          12px 15px 0 var(--accent), 3px 15px 0 var(--accent);
      }
      /* Frame 4: Cat walking - legs wide */
      75.01%, 100% {
        box-shadow:
          /* Ears */
          3px 0 0 var(--accent), 9px 0 0 var(--accent),
          /* Head */
          3px 3px 0 var(--accent), 6px 3px 0 var(--accent), 9px 3px 0 var(--accent),
          0 6px 0 var(--accent), 3px 6px 0 var(--accent), 6px 6px 0 var(--accent), 9px 6px 0 var(--accent), 12px 6px 0 var(--accent),
          /* Eyes */
          3px 6px 0 #fff, 9px 6px 0 #fff,
          /* Body */
          3px 9px 0 var(--accent), 6px 9px 0 var(--accent), 9px 9px 0 var(--accent), 12px 9px 0 var(--accent), 15px 9px 0 var(--accent),
          3px 12px 0 var(--accent), 6px 12px 0 var(--accent), 9px 12px 0 var(--accent), 12px 12px 0 var(--accent),
          /* Tail up */
          18px 6px 0 var(--accent), 21px 3px 0 var(--accent),
          /* Legs - wide */
          0 15px 0 var(--accent), 15px 15px 0 var(--accent);
      }
    }

    h1 {
      font-family: 'Pixelify Sans', sans-serif;
      font-size: 28px;
      font-weight: 700;
      letter-spacing: 0;
      margin-bottom: 6px;
      text-align: center;
      animation: textIn 0.5s ease 0.1s both;
      background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent) 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      text-align: center;
      margin-bottom: 28px;
      animation: textIn 0.5s ease 0.15s both;
    }

    @keyframes textIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Steps */
    .step {
      display: none;
      width: 100%;
      max-width: 440px;
      animation: stepIn 0.3s ease;
    }

    .step.active {
      display: block;
    }

    @keyframes stepIn {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* Auth Options */
    .auth-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 24px;
    }

    .auth-option {
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .auth-option:hover {
      border-color: var(--accent);
      background: var(--bg-tertiary);
    }

    .auth-option.selected {
      border-color: var(--accent);
      background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%);
    }

    .auth-option-icon {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .auth-option-icon.api {
      background: linear-gradient(135deg, #10b981, #059669);
    }

    .auth-option-icon.oauth {
      background: linear-gradient(135deg, var(--orange), #ea580c);
    }

    .auth-option-icon svg {
      width: 24px;
      height: 24px;
      color: white;
    }

    .auth-option-text h3 {
      font-family: 'Pixelify Sans', sans-serif;
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .auth-option-text p {
      font-size: 13px;
      color: var(--text-muted);
    }

    .auth-option-badges {
      margin-left: auto;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
    }

    .auth-option-badge {
      padding: 4px 8px;
      background: var(--success);
      color: white;
      border-radius: 16px;
      font-size: 10px;
      font-weight: 500;
      white-space: nowrap;
    }

    .auth-option-badge.risk {
      background: rgba(239, 68, 68, 0.15);
      color: var(--error);
      cursor: help;
      position: relative;
    }

    .auth-option-badge.risk .risk-info {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 1px solid var(--error);
      font-size: 9px;
      font-weight: 700;
      line-height: 1;
    }

    .risk-tooltip {
      display: none;
      position: absolute;
      bottom: calc(100% + 8px);
      right: 0;
      width: 260px;
      padding: 10px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 400;
      text-transform: none;
      color: var(--text-secondary);
      line-height: 1.5;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      z-index: 10;
      white-space: normal;
    }

    .auth-option-badge.risk:hover .risk-tooltip {
      display: block;
    }

    /* Form */
    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--text-secondary);
    }

    .form-group input {
      width: 100%;
      padding: 12px 14px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    .form-group input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.15), 0 0 20px rgba(168, 85, 247, 0.1);
    }

    .form-group input::placeholder {
      color: var(--text-muted);
    }

    .form-group input[type="password"] {
      font-family: monospace;
      letter-spacing: 1px;
    }

    .form-group .hint {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    .form-group .hint a {
      color: var(--accent);
      text-decoration: none;
    }

    .form-group .hint a:hover {
      text-decoration: underline;
    }

    /* Status */
    .status {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      font-size: 13px;
      line-height: 1.5;
      padding: 12px 14px;
      border-radius: var(--radius-sm);
      margin-bottom: 16px;
    }

    .status svg {
      margin-top: 2px;
    }

    .status.success {
      background: rgba(34, 197, 94, 0.1);
      color: var(--success);
    }

    .status.error {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error);
    }

    .status.info {
      background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%);
      color: var(--accent);
    }

    .status svg {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    .status span {
      flex: 1;
    }

    /* Buttons */
    .button-row {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      margin-bottom: 16px;
    }

    button {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      white-space: nowrap;
      min-height: 46px;
    }

    button.primary {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-secondary) 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);
    }

    button.primary:hover:not(:disabled) {
      background: linear-gradient(135deg, var(--accent-hover) 0%, var(--accent) 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(168, 85, 247, 0.4);
    }

    button.primary:active:not(:disabled) {
      transform: translateY(0);
    }

    button.secondary {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }

    button.secondary:hover {
      background: var(--border);
      color: var(--text-primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    button.secondary:active {
      transform: translateY(0);
    }

    button.oauth {
      background: var(--orange);
      color: white;
    }

    button.oauth:hover:not(:disabled) {
      background: #ea580c;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    button svg {
      width: 18px;
      height: 18px;
    }

    .spinner {
      width: 18px;
      height: 18px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Divider */
    .divider {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 24px 0;
      color: var(--text-muted);
      font-size: 12px;
    }

    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    /* Success */
    .success-icon {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, rgba(168, 85, 247, 0.15) 0%, rgba(236, 72, 153, 0.15) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      animation: successPop 0.5s cubic-bezier(0.16, 1, 0.3, 1);
      box-shadow: 0 8px 24px rgba(168, 85, 247, 0.2);
    }

    @keyframes successPop {
      from { opacity: 0; transform: scale(0.5); }
      50% { transform: scale(1.1); }
      to { opacity: 1; transform: scale(1); }
    }

    .success-icon svg {
      width: 32px;
      height: 32px;
      color: var(--accent);
    }

    .success-text {
      text-align: center;
    }

    .success-text h2 {
      font-family: 'Pixelify Sans', sans-serif;
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .success-text p {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Optional section */
    .optional-section {
      margin-top: 16px;
      margin-bottom: 12px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    .optional-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      cursor: pointer;
    }

    .optional-header h4 {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .optional-header svg {
      width: 16px;
      height: 16px;
      color: var(--text-muted);
      transition: transform 0.2s;
    }

    .optional-header.expanded svg {
      transform: rotate(180deg);
    }

    .optional-content {
      display: none;
    }

    .optional-content.show {
      display: block;
      animation: slideDown 0.2s ease;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Permission items */
    .perm-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
    }

    .perm-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .perm-icon.granted {
      background: rgba(34, 197, 94, 0.15);
      color: var(--success);
    }

    .perm-icon.missing {
      background: rgba(249, 115, 22, 0.15);
      color: var(--orange);
    }

    .perm-icon svg {
      width: 18px;
      height: 18px;
    }

    .perm-text {
      flex: 1;
      min-width: 0;
    }

    .perm-text h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .perm-text p {
      font-size: 12px;
      color: var(--text-muted);
    }

    .perm-action button {
      flex: none;
      min-height: 32px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 500;
    }

    /* Skip link */
    .skip-link {
      margin-top: 20px;
      text-align: center;
    }

    .skip-link a {
      font-size: 13px;
      color: var(--text-muted);
      text-decoration: none;
      cursor: pointer;
    }

    .skip-link a:hover {
      color: var(--text-secondary);
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="onboarding">
    <div class="logo"></div>

    <h1>Pocket Agent</h1>
    <p class="subtitle">i'm Franky, your new 24/7 assistant</p>

    <!-- Step 0: Secure Storage Initialization -->
    <div class="step active" id="step-keychain">
      <div id="keychain-status"></div>

      <div class="status info">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        <span id="keychain-info-text">Pocket Agent uses your system's secure storage to protect API keys.</span>
      </div>

      <div class="button-row">
        <button class="primary" id="keychain-btn" onclick="playNormalClick(); initKeychain()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          Secure My Keys
        </button>
      </div>

      <div class="skip-link">
        <a onclick="playNormalClick(); skipKeychain()">skip for now</a>
      </div>
    </div>

    <!-- Step 0.5: macOS Permissions -->
    <div class="step" id="step-permissions">
      <div class="status info">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        <span>These permissions let me read iMessage, Safari, and control apps on your behalf. You can grant them now or later.</span>
      </div>

      <div id="permissions-list"></div>

      <div class="button-row">
        <button class="secondary" onclick="playNormalClick(); showStep('step-keychain')">Back</button>
        <button class="secondary" id="perm-refresh-btn" onclick="playNormalClick(); refreshPermissions()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
          Refresh
        </button>
        <button class="primary" onclick="playNormalClick(); showStep('step-auth')">
          Continue
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
        </button>
      </div>

      <div class="skip-link">
        <a onclick="playNormalClick(); showStep('step-auth')">skip permissions</a>
      </div>
    </div>

    <!-- Step 1: Choose Auth Method -->
    <div class="step" id="step-auth">
      <div class="auth-options">
        <div class="auth-option" onclick="playNormalClick(); selectAuth('oauth', this)">
          <div class="auth-option-icon oauth">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
          </div>
          <div class="auth-option-text">
            <h3>Sign in with Claude</h3>
            <p>Use your Claude Pro or Max subscription</p>
          </div>
          <div class="auth-option-badges">
            <span class="auth-option-badge">Best Choice</span>
            <span class="auth-option-badge risk">
              Use at own risk
              <span class="risk-info">i</span>
              <span class="risk-tooltip">Anthropic may restrict accounts using unofficial OAuth integrations. This is not an officially supported auth method. Use at your own risk.</span>
            </span>
          </div>
        </div>

        <div class="auth-option" onclick="playNormalClick(); selectAuth('api', this)">
          <div class="auth-option-icon api">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
          </div>
          <div class="auth-option-text">
            <h3>Use API Key</h3>
            <p>Enter your Anthropic, Kimi, or GLM API key</p>
          </div>
        </div>
      </div>

      <div class="skip-link">
        <a onclick="playNormalClick(); goBackFromAuth()">back</a>
      </div>
    </div>

    <!-- Step 2a: OAuth Flow - Start -->
    <div class="step" id="step-oauth">
      <div id="oauth-status"></div>

      <div class="status info">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
        <span>Click below to open Claude sign-in. After signing in, copy the code and paste it here.</span>
      </div>

      <div class="button-row">
        <button class="secondary" onclick="playNormalClick(); showStep('step-auth')">Back</button>
        <button class="oauth" id="oauth-btn" onclick="playNormalClick(); startOAuth()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
          Sign in
        </button>
      </div>
    </div>

    <!-- Step 2a-2: OAuth Code Entry -->
    <div class="step" id="step-oauth-code">
      <div id="oauth-code-status"></div>

      <div class="status info">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
        <span>Paste the authorization code from your browser</span>
      </div>

      <div class="form-group">
        <label>Authorization Code</label>
        <input type="text" id="oauth-code" placeholder="paste the magic code here..." autofocus>
        <p class="hint">After signing in, you'll see a code. Copy and paste it above.</p>
      </div>

      <div class="button-row">
        <button class="secondary" onclick="playNormalClick(); cancelOAuth()">Cancel</button>
        <button class="primary" id="oauth-complete-btn" onclick="playNormalClick(); completeOAuth()">
          Continue
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
        </button>
      </div>

      <div class="optional-section">
        <div class="optional-header" onclick="playNormalClick(); toggleOptional(this)">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
          <h4>bonus: add more AI providers</h4>
        </div>
        <div class="optional-content" id="optional-extra-oauth">
          <div class="form-group">
            <label>Kimi (Moonshot) API Key</label>
            <input type="password" id="kimi-key-oauth" placeholder="sk-...">
            <p class="hint">Get from <a href="https://platform.moonshot.ai/" target="_blank">platform.moonshot.ai</a></p>
          </div>
          <div class="form-group">
            <label>GLM (Z.AI) API Key</label>
            <input type="password" id="glm-key-oauth" placeholder="...">
            <p class="hint">Get from <a href="https://z.ai/manage-apikey/apikey-list" target="_blank">z.ai</a></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 2b: API Key Entry -->
    <div class="step" id="step-api">
      <div id="api-status"></div>

      <div class="status info" style="margin-bottom: 16px;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
        <span>Enter at least one key to get started. Add more for access to additional models.</span>
      </div>

      <div class="form-group">
        <label>Anthropic API Key</label>
        <input type="password" id="anthropic-key" placeholder="sk-ant-..." autofocus>
        <p class="hint">Get from <a href="https://console.anthropic.com/settings/keys" target="_blank">console.anthropic.com</a></p>
      </div>

      <div class="form-group">
        <label>Kimi (Moonshot) API Key</label>
        <input type="password" id="kimi-key-api" placeholder="sk-...">
        <p class="hint">Get from <a href="https://platform.moonshot.ai/" target="_blank">platform.moonshot.ai</a></p>
      </div>

      <div class="form-group">
        <label>GLM (Z.AI) API Key</label>
        <input type="password" id="glm-key-api" placeholder="...">
        <p class="hint">Get from <a href="https://z.ai/manage-apikey/apikey-list" target="_blank">z.ai</a></p>
      </div>

      <div class="button-row">
        <button class="secondary" onclick="playNormalClick(); showStep('step-auth')">Back</button>
        <button class="primary" id="api-btn" onclick="playNormalClick(); validateAndSave()">
          Continue
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
        </button>
      </div>
    </div>

    <!-- Step 3: Success -->
    <div class="step" id="step-success">
      <div class="success-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
      </div>

      <div class="success-text">
        <h2>you're good to go! üéâ</h2>
        <p id="success-hint">double-click the tray icon to start chatting</p>
      </div>

      <div class="button-row" style="margin-top: 24px;">
        <button class="primary" onclick="playNormalClick(); finishSetup()">
          Let's Chat!
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Click Sound -->
  <audio id="normal-click-sound" preload="auto" src="../assets/normal-click.mp3"></audio>

  <script>
    // Click sound
    const normalClickSound = document.getElementById('normal-click-sound');
    function playNormalClick() {
      if (normalClickSound) {
        normalClickSound.currentTime = 0;
        normalClickSound.play().catch(() => {});
      }
    }
    document.addEventListener('click', (e) => {
      if (e.target.closest('button, .toggle, .tab, .auth-option, select')) {
        playNormalClick();
      }
    });

    let selectedAuth = null;
    let keychainInitialized = false;

    // Platform-specific text
    const platform = window.pocketAgent.getPlatform();
    const platformText = (() => {
      if (platform === 'darwin') {
        return {
          storageInfo: "Pocket Agent uses your Mac's Keychain to securely store API keys. You may be prompted for your Mac password.",
          storageFallback: 'Could not access Keychain. Keys will be stored unencrypted.',
          trayHint: 'double-click the tray icon to start chatting',
        };
      } else if (platform === 'win32') {
        return {
          storageInfo: "Pocket Agent uses Windows Credential Store to securely store API keys.",
          storageFallback: 'Could not access Credential Store. Keys will be stored unencrypted.',
          trayHint: 'double-click the system tray icon to start chatting',
        };
      } else {
        return {
          storageInfo: "Pocket Agent uses your system keyring to securely store API keys. You may be prompted for your keyring password.",
          storageFallback: 'Could not access system keyring. Keys will be stored unencrypted.',
          trayHint: 'click the tray icon to start chatting',
        };
      }
    })();

    // Apply platform-specific text
    document.getElementById('keychain-info-text').textContent = platformText.storageInfo;
    document.getElementById('success-hint').textContent = platformText.trayHint;

    async function initKeychain() {
      const btn = document.getElementById('keychain-btn');
      const statusDiv = document.getElementById('keychain-status');

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Initializing...';

      try {
        const result = await window.pocketAgent.initializeKeychain();

        if (result.available) {
          keychainInitialized = true;
          statusDiv.innerHTML = `
            <div class="status success">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
              Secure storage enabled! Your keys are safe with me üîê
            </div>
          `;
          setTimeout(() => checkAndShowPermissions(), 1000);
        } else {
          statusDiv.innerHTML = `
            <div class="status error">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
              ${result.error || platformText.storageFallback}
            </div>
          `;
          btn.disabled = false;
          btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg> Try Again`;
        }
      } catch (err) {
        statusDiv.innerHTML = `
          <div class="status error">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
            <span>${err.message || 'Failed to initialize secure storage'}</span>
          </div>
        `;
        btn.disabled = false;
        btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg> Try Again`;
      }
    }

    function skipKeychain() {
      checkAndShowPermissions();
    }

    // Track whether we showed permissions step (for back navigation)
    let permissionsShown = false;

    async function checkAndShowPermissions() {
      try {
        const mac = await window.pocketAgent.isMacOS();
        if (!mac) {
          showStep('step-auth');
          return;
        }
        permissionsShown = true;
        showStep('step-permissions');
        refreshPermissions();
      } catch {
        // If check fails, just skip to auth
        showStep('step-auth');
      }
    }

    async function refreshPermissions() {
      const container = document.getElementById('permissions-list');
      const btn = document.getElementById('perm-refresh-btn');
      const refreshIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>';

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Checking...';

      try {
        const statuses = await window.pocketAgent.checkPermissions([
          'full-disk-access',
          'accessibility',
          'screen-recording',
        ]);
        renderPermissionsList(statuses);
      } catch (err) {
        container.innerHTML = `
          <div class="status error">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
            <span>Could not check permissions</span>
          </div>
        `;
      }

      btn.disabled = false;
      btn.innerHTML = refreshIcon + ' Refresh';
    }

    function renderPermissionsList(statuses) {
      const container = document.getElementById('permissions-list');
      container.innerHTML = statuses.map(s => {
        const iconClass = s.granted ? 'granted' : 'missing';
        const iconSvg = s.granted
          ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>'
          : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="8" y1="12" x2="16" y2="12"/></svg>';
        const hint = (!s.granted && s.type === 'full-disk-access')
          ? '<p style="color: var(--orange); margin-top: 2px;">Requires app restart to detect</p>'
          : '';
        const actionHtml = s.granted
          ? ''
          : `<div class="perm-action"><button class="secondary" onclick="playNormalClick(); openPermSettings('${s.type}')">Open Settings</button></div>`;
        return `
          <div class="perm-item">
            <div class="perm-icon ${iconClass}">${iconSvg}</div>
            <div class="perm-text">
              <h4>${s.label}</h4>
              <p>${s.description}</p>
              ${hint}
            </div>
            ${actionHtml}
          </div>
        `;
      }).join('');
    }

    async function openPermSettings(type) {
      try {
        await window.pocketAgent.openPermissionSettings(type);
      } catch (err) {
        console.error('Failed to open permission settings:', err);
      }
    }

    function goBackFromAuth() {
      if (permissionsShown) {
        showStep('step-permissions');
      } else {
        showStep('step-keychain');
      }
    }

    function selectAuth(method, el) {
      selectedAuth = method;

      // Update selection UI
      document.querySelectorAll('.auth-option').forEach(opt => opt.classList.remove('selected'));
      el.classList.add('selected');

      // Show appropriate step after short delay
      setTimeout(() => {
        if (method === 'oauth') {
          showStep('step-oauth');
        } else {
          showStep('step-api');
          document.getElementById('anthropic-key').focus();
        }
      }, 200);
    }

    function showStep(stepId) {
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      document.getElementById(stepId).classList.add('active');

      // Reset step states when navigating back
      const refreshIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>';

      if (stepId === 'step-keychain') {
        const btn = document.getElementById('keychain-btn');
        btn.disabled = false;
        if (keychainInitialized) {
          btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Secured';
        } else {
          btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg> Secure My Keys';
        }
        document.getElementById('keychain-status').innerHTML = '';
      } else if (stepId === 'step-permissions') {
        const btn = document.getElementById('perm-refresh-btn');
        btn.disabled = false;
        btn.innerHTML = refreshIcon + ' Refresh';
        refreshPermissions();
      } else if (stepId === 'step-auth') {
        document.querySelectorAll('.auth-option').forEach(el => el.classList.remove('selected'));
      } else if (stepId === 'step-oauth') {
        document.getElementById('oauth-status').innerHTML = '';
        const btn = document.getElementById('oauth-btn');
        btn.disabled = false;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg> Sign in';
      } else if (stepId === 'step-oauth-code') {
        document.getElementById('oauth-code-status').innerHTML = '';
        document.getElementById('oauth-code').value = '';
        const btn = document.getElementById('oauth-complete-btn');
        btn.disabled = false;
        btn.innerHTML = 'Continue <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>';
      } else if (stepId === 'step-api') {
        document.getElementById('api-status').innerHTML = '';
        const btn = document.getElementById('api-btn');
        btn.disabled = false;
        btn.innerHTML = 'Continue <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>';
      }
    }

    function toggleOptional(header) {
      const content = header.nextElementSibling;
      header.classList.toggle('expanded');
      content.classList.toggle('show');
    }

    async function startOAuth() {
      const btn = document.getElementById('oauth-btn');
      const statusDiv = document.getElementById('oauth-status');

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Opening browser...';

      try {
        // Start OAuth flow - opens browser
        const result = await window.pocketAgent.startOAuth();

        if (result.success) {
          // Show the code entry step
          showStep('step-oauth-code');
          document.getElementById('oauth-code').focus();
        } else {
          statusDiv.innerHTML = `
            <div class="status error">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
              ${result.error || 'Failed to open browser. Please try again.'}
            </div>
          `;
        }
      } catch (err) {
        statusDiv.innerHTML = `
          <div class="status error">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
            ${err.message || 'Connection failed'}
          </div>
        `;
      }

      btn.disabled = false;
      btn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
        Sign in
      `;
    }

    async function completeOAuth() {
      const code = document.getElementById('oauth-code').value.trim();
      const statusDiv = document.getElementById('oauth-code-status');
      const btn = document.getElementById('oauth-complete-btn');

      if (!code) {
        statusDiv.innerHTML = `
          <div class="status error">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
            Please paste the authorization code from your browser
          </div>
        `;
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Verifying...';
      statusDiv.innerHTML = '';

      try {
        // Exchange code for tokens
        const result = await window.pocketAgent.completeOAuth(code);

        if (result.success) {
          // Save Kimi key if provided
          const kimiKey = document.getElementById('kimi-key-oauth').value.trim();
          if (kimiKey) {
            await window.pocketAgent.setSetting('moonshot.apiKey', kimiKey);
          }

          // Save GLM key if provided
          const glmKey = document.getElementById('glm-key-oauth').value.trim();
          if (glmKey) {
            await window.pocketAgent.setSetting('glm.apiKey', glmKey);
          }

          showStep('step-success');
        } else {
          statusDiv.innerHTML = `
            <div class="status error">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
              ${result.error || 'Invalid code. Please try again.'}
            </div>
          `;
        }
      } catch (err) {
        statusDiv.innerHTML = `
          <div class="status error">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
            ${err.message || 'Verification failed'}
          </div>
        `;
      }

      btn.disabled = false;
      btn.innerHTML = `Continue <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>`;
    }

    async function cancelOAuth() {
      try {
        await window.pocketAgent.cancelOAuth();
      } catch (err) {
        console.error('Failed to cancel OAuth:', err);
      }
      // Clear the code input
      document.getElementById('oauth-code').value = '';
      document.getElementById('oauth-code-status').innerHTML = '';
      // Go back to auth selection
      showStep('step-auth');
    }

    async function validateAndSave() {
      const anthropicKey = document.getElementById('anthropic-key').value.trim();
      const kimiKey = document.getElementById('kimi-key-api').value.trim();
      const glmKey = document.getElementById('glm-key-api').value.trim();
      const statusDiv = document.getElementById('api-status');
      const btn = document.getElementById('api-btn');

      if (!anthropicKey && !kimiKey && !glmKey) {
        statusDiv.innerHTML = `
          <div class="status error">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
            Please enter at least one API key
          </div>
        `;
        return;
      }

      // Validate Anthropic key format if provided
      if (anthropicKey && !/^sk-ant-[A-Za-z0-9_-]{90,}$/.test(anthropicKey)) {
        statusDiv.innerHTML = `
          <div class="status error">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
            Anthropic keys start with "sk-ant-"
          </div>
        `;
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Validating...';
      statusDiv.innerHTML = '';

      try {
        // Validate Anthropic key if provided
        if (anthropicKey) {
          const result = await window.pocketAgent.validateAnthropicKey(anthropicKey);
          if (!result.valid) {
            statusDiv.innerHTML = `
              <div class="status error">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                ${result.error || 'Invalid Anthropic API key'}
              </div>
            `;
            btn.disabled = false;
            btn.innerHTML = 'Continue <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>';
            return;
          }
        }

        // Save keys
        await window.pocketAgent.setSetting('auth.method', 'api_key');

        if (anthropicKey) {
          await window.pocketAgent.setSetting('anthropic.apiKey', anthropicKey);
        }
        if (kimiKey) {
          await window.pocketAgent.setSetting('moonshot.apiKey', kimiKey);
        }
        if (glmKey) {
          await window.pocketAgent.setSetting('glm.apiKey', glmKey);
        }

        // Auto-select a model matching the first available provider key
        // so the agent doesn't start with a mismatched default model
        const currentModel = await window.pocketAgent.getSetting('agent.model');
        const isAnthropicModel = !currentModel || currentModel.startsWith('claude-');
        if (isAnthropicModel && !anthropicKey) {
          // Default model is Anthropic but user didn't provide an Anthropic key
          if (kimiKey) {
            await window.pocketAgent.setSetting('agent.model', 'kimi-k2.5');
          } else if (glmKey) {
            await window.pocketAgent.setSetting('agent.model', 'glm-4.7');
          }
        }

        showStep('step-success');

      } catch (err) {
        statusDiv.innerHTML = `
          <div class="status error">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
            ${err.message || 'Validation failed'}
          </div>
        `;
        btn.disabled = false;
        btn.innerHTML = 'Continue <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>';
      }
    }

    async function finishSetup() {
      // Restart agent with new settings and open chat
      try {
        await window.pocketAgent.restartAgent();
        await window.pocketAgent.openChat();
      } catch (err) {
        console.error('Failed to finish setup:', err);
      }
      window.close();
    }

    // Handle Enter key
    document.getElementById('anthropic-key').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') validateAndSave();
    });

    document.getElementById('oauth-code').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') completeOAuth();
    });
  </script>
</body>
</html>
